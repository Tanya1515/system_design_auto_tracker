# System Design для приложения Auto Tracker
Курс Владимира Балуна по System Design

**Auto Tracker** - приложение, которое позволяет находить подходящие заправки по запросу пользователя. 

### Требования к приложению

***Функциональные требования***

1. Есть только мобильная версия приложения
2. У каждого пользователя есть профиль со следующими полями:
   - Логин
   - Номер телефона
   - Список марок топлива (которые необходимы пользователю)
   - Радиус поиска заправок (км)
   - Список брендов искомых заправок
3. У каждой заправки есть следующие поля:
   - Адрес заправки (*)
   - Бренд заправки (*)
   - Открыта/закрыта и часы работы
   - Список марок топлива и цена (*)
   - Рейтинг (*)
4. При входе пользователь проходит аутентификацию по номеру телефона
5. После поиска заправок высвечивается список заправок. Для каждой заправки отображается краткая информация о ней - поля, помеченные *. 
6. Пользователю доступна карта с его текущей геопозицией со следующими полями:
   - Иконка с текущей геопозицией
   - Список ближайших заправок
   - Карта с отображением дорог, лесов, заправок
7. Приложение позволяет построить маршрут от текущего местоположения пользователя до запрашиваемой заправки. Маршрут строится по следующим критериям:
   - Пробки
   - Кратчайший путь
   - Наличие платных дорог в маршруте пользователя 
8. Приложение позволяет искать заправки по следующим критериям: 
   - Рейтинг заправки (ищем самые высокорейтенговые)
   - Бренд заправки (фильтруется по брендам пользователя)
   - Марки топлива (фильтруется по маркам топлива пользователя)
   - Время работы заправки
   - Местоположение (необходимо найти ближайщие)
9. Пользователь может запустить режим мониторинга, в результате которого включается поиск заправок, и пользователь получает увеомления при приближении к подходящей заправке
10. После того, как пользователь посетил заправку, приложение просит оценить заправку.
   
***Нефункциональные требования***

1. DAU - 4_000_000
2. Аудитория - РФ
3. Сезонность - летом количество трафика повышается на 30%, зимой пользуются меньше
4. Активность пользователей:
   - Персональные данные обновляются 1 раз в неделю
   - Пользователь посещает заправку и осуществляет поиск заправки 1 раз в два дня
5. Лимиты:  
   - Радиус поиска заправки - 100км = 100 000м
   - Количество заправок - до 50
   - 30 - количество брендов заправок в приложении
   - 10 - марки топлива
   - После выбора заправки приложение предоставлыяет на выбор 3 маршрута до нее
6.  Тайминги: 
   - Определение геопозиции = 5 секунд
   - Поиск заправок = 3 секунды
   - Построение маршрута = 5 секунд
   - Отображение детализированной информации о заправке = 1 секунда

***RPS***

READ: 

Отображение карты: 4_000_000 / 172 800 = 23

Отображение списка заправок: 4_000_000 * 50 / 172 800 = 1150

Отображение детализированной информации по станции: 4_000_000 * 4 / 172 800 = 132

Отображение уведомления: 4_000_000 * 10 / 172 800  = 230

Отображение маршрутов до заправки: 3 * 4_000_000 / 172 800 = 69

WRITE: 

Регистрация пользователя: 4_000_000 / 604800 = 6

Отправка рейтинга: 4_000_000 / 172 800 = 23

***Traffic***

User (300b): 

- user_id - 16b
- name - 50 * 4b
- phone - 13b
- marks - 10 * b
- brands - 30  *b
- radius - 1b

Object (32b):

- object_id - 16b
- latitude - 8b // широта x
- longitude - 8b  // долгота y

Station (300b): 

- station_id - 16b
- address - 50 * 4 * b
- brand - b
- marks - 10 * b
- price - 10 * b
- rate - 4 * b
- adds - 20 * b

Road (8 Kb): 

- path_id - 16b
- name - 50 * 4b
- way - 2 * 501 * 8b

Push (1,5 Kb): 

- push_id - 16b
- giff - 1024 kb
- address - 50 * 4 * b
- brand - 10 * 4 * b
- distance - 10 * 4 * b

Отображение карты: 23 * 50 *8 Kb = 9200 Kb/s

Отображение списка заправок: 1150 * 280b  = 314 Kb/s

Отображение детализированной информации по станции: 132 * 300b = 38 Kb/s

Отображение уведомления: 230 * 1,5Kb = 345 Kb/s

Отображение маршрутов до заправки: 69 * 3 * 8Kb = 1656 Kb/s

Регистрация пользователя: 6 * 350b = 2100b/s

Отправка рейтинга: 23 * 20b = 460b/s

### Диски

Количество дорог в РФ: около 1_000_000 

Количество заправочных стандий в РФ: около 29_000 

Количество рек, озер и остальных водоемов в РФ: около 2_500_000

Количество лесов/полей: около 80_000_000 

Количество населенных пунктов в Рф: около 160_000 

Объекты в базе данных хранятся как GEOMETRY, который может быть одним из трех типов:

1) Point - примерно 32 байта
2) Linestring с N точками - примерно  (32 + 16 * N) байт
3) Polygon с M кольцами и N точками - 32 + 16*N + 8*M байт

 * Пусть в текущей конфигурации каждая дорога дробится в среднем на 200 точек, а Polygon с M=1 дробится на 100 точек.

capacity для дорог = Linestring * 1_000_000 = (32 + 16 * 200) * 1_000_000 = 3 Gb = 0.3 Tb
capacity для заправочных станций и населенных пунктов = Point * (29_000 + 160_000) = 32 * 189_000 = 6 Mb - очень мало отнительно Tb
capacity для водоемов и лесов/полей = Polygon * ( 80_000_000 + 2_500_000 ) = (32 + 16*100 + 8) * 82_500_000 = 126 TB

CAPACITY = приблизительный объем хранимых данных для карт + Traffic (write) * 24*60*60 (сколько приходит за сутки) * 365 (количество дней в году) + картинки = 126 + 0.3 + 2560 * 24*60*60 * 365 + 1024 kb * 10 = 75 Gb + 126.3 Tb + 1024 kb * 10 ~ 200 Tb (берем с запасом) => для хранения данных

 RPS(read) + RPS(write) / количество операций ддля ввода/вывода = 23 + 1150 + 132 + 230 + 69 + 6 + 3 / 100 (или 1000) (количество операций ввода/вывода примерное) ~ 16 HDD-дисков или 2 SSD-диска

Traffic(read) + Traffic(write) / 100 mb/s (пропускная способность жесткого диска) ~ 1 HDD или 1 SSD.

Следовательно необходимо: 17 HDD дисков по 14 Tb или 2 SSD диска по 100 Tb

### Шардирование



